<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-styles/typography.html">

<dom-module id="luc-login">
  <template>
    <style>
        :host {
            display: block;
        }
        .login-field {
            background-color: lightgrey;
            width: 400px;
            height: 200px;
            margin: auto;
        }
        .inputs {
            padding: 10px 20px;
        }
        .inputs paper-input {
            width: 100%;
            float: right;
            clear: both;
        }
        .buttons {
            float: right;
            clear: both;
            padding: 10px 20px;
        }
    </style>
    <iron-ajax id="login" method="POST" content-type="application/json" url="/api/rpc/login" on-response="handleLogin" on-error="handleError"></iron-ajax>
    <iron-ajax id="signup" method="POST" content-type="application/json" url="/api/rpc/signup" on-response="handleRegister" on-error="handleError"></iron-ajax>
    <iron-ajax id="current_id" method="POST" content-type="application/json" url="/api/rpc/current_id" on-response="handleLoggedIn"></iron-ajax>
    <div class="login-field">
        <div class="inputs">
            <paper-input id="summoner" label="Summoner Name" type="text"></paper-input>
            <paper-input id="pw" label="Password" type="password"></paper-input>
        </div>
        <div class="buttons">
            <paper-button on-click="register">Register</paper-button>
            <paper-button on-click="login">Login</paper-button>
        </div>
    </div>
    <paper-toast id="toast"></paper-toast>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'luc-login',

        properties: {
        },

        handleClick: function (id) {
            var ajax = document.getElementById(id);
            ajax.body = JSON.stringify({
                "leaguename": document.getElementById("summoner").value,
                "pass": document.getElementById("pw").value,
                "region": "EUW"
            });
            ajax.generateRequest();
        },

        register: function () {
            this.handleClick("signup");
        },

        handleRegister: function () {
            document.getElementById("toast").show({text: "Erfolgreich registriert. Login sollte in 1-2 Minuten möglich sein.", duration: 3000});
        },

        login: function () {
            this.handleClick("login");
        },

        handleLogin: function () {
            var response = document.getElementById("login").lastResponse;
            document.cookie = "token=" + response.token;

            var current_id = document.getElementById("current_id");
            current_id.withCredentials = true;
            current_id.body = JSON.stringify({});
            current_id.headers["Authorization"] = "Bearer " + response.token;
            current_id.generateRequest();
        },

        handleLoggedIn: function () {
            var response = document.getElementById("current_id").lastResponse;
            document.cookie = "id=" + response.id;

            page.redirect("/profile");
        },

        handleError: function () {
            document.getElementById("toast").show({text: "Ein Fehler ist aufgetreten. Fidge123 und kurojutsu können (hoffentlich) helfen :D", duration: 10000});
        }
      });
    })();
  </script>
</dom-module>
