<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-styles/typography.html">

<dom-module id="luc-profile">
  <template>
    <style>
        :host {
            display: block;
        }
        .main {
            width: 800px;
            margin: auto;
        }
        .metadata {
            width: 800px;
            height: 160px;
            padding-bottom: 30px;
        }
        .metadata > * {
            display: inline-block;
        }
        .icon {
            width: 160px;
            height: 160px;
        }
        .name {
            vertical-align: top;
            width: 350px;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 20px;
            font-size: 36px;
        }
        .overall {
            font-size: 24px;
            width: 240px;
            vertical-align: top;
            text-align: right;
        }
        .overall * {
            padding-top: 20px;
        }
        .overview * {
            display: inline-block;
        }
        .card {
            background: #eee;
            width: 240px;
            height: 80px;
        }
        .pad {
            margin: 0 35px;
        }
        .cap {
            width: 80px;
            text-align: center;
            line-height: 80px;
            font-size: 36px;
        }
        .details {
            width: 150px;
        }
        .details * {
            display: block;
        }
    </style>
    <iron-ajax id="a_player" url="/api/player" params='{"order":"points.desc.nullslast", "select":"leaguename,points,id"}' headers="{{header}}" on-response="handlePlayerInfo" auto></iron-ajax>
    <iron-ajax id="a_pam" url="/api/player_achievement_match" params='{"playerid":"eq.21636783"}' headers="{{header}}" on-response="handleAchievements" auto></iron-ajax>
    <iron-ajax id="a_achieve" url="/api/achievement" headers="{{header}}" last-response="{{aList}}" auto></iron-ajax>
    <iron-ajax id="a_grp" url="/api/game_repeatable_player" params='{"playerid":"eq.21636783"}' headers="{{header}}" on-response="handleRepeatables" auto></iron-ajax>
    <iron-ajax id="a_repeat" url="/api/repeatable" headers="{{header}}" last-response="{{rList}}" auto></iron-ajax>
    <div class="main">
        <div class="header">
            <div class="metadata">
                <img class="icon" src="http://ddragon.leagueoflegends.com/cdn/6.9.1/img/profileicon/588.png"/>
                <div class="name">{{player}}</div>
                <div class="overall">
                    <div>{{place}}. Platz</div>
                    <div>{{points}} Punkte</div>
                </div>
            </div>
            <div class="overview">
                <div class="card">
                    <div class="cap">
                        A
                    </div>
                    <div class="details">
                        <div class="title">
                            Achievements
                        </div>
                        <div class="stats">
                            {{achievements}}
                        </div>
                    </div>
                </div>
                <div class="card pad">
                    <div class="cap">
                        R
                    </div>
                    <div class="details">
                        <div class="title">
                            Repeatables
                        </div>
                        <div class="stats">
                            {{repeatables}}
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="cap">
                        H
                    </div>
                    <div class="details">
                        <div class="title">
                            Hall of Fame
                        </div>
                        <div class="stats">
                            Noch nicht verf√ºgbar
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </paper-material>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'luc-profile',

        properties: {
            player: {
                type: String
            },
            place: {
                type: Object
            },
            points: {
                type: String
            },
            achievements: {
                type: String
            },
            repeatables: {
                type: String
            },
            pid: {
                type: Number
            },
            header: {
                type: Object
            },
            aList: {
                type: Array
            },
            rList: {
                type: Array
            }
        },

        getCookie: function (key) {
            var cookieIndex = document.cookie.indexOf(key + "=");
            var endIndex = document.cookie.indexOf(";", cookieIndex);
            endIndex = endIndex < cookieIndex ? document.cookie.length : endIndex;

            if (cookieIndex !== -1) {
                return document.cookie.substring(cookieIndex + key.length + 1, endIndex);
            }
            return "";
        },

        handleAchievements: function () {
            var that = this;
            var response = document.getElementById("a_pam").lastResponse;
            if (!this.aList) {
                setTimeout(function () {
                    console.log("waiting A");
                    that.handleAchievements(response);
                }, 200);
            } else {
                this.achievements = response.reduce(function (value, element) {
                    var achievement = that.aList.filter(function (a) {
                        return a.id === element.achievementid;
                    });
                    return value + achievement[0].points;
                }, 0);
            }
        },

        handleRepeatables: function () {
            var that = this;
            var response = document.getElementById("a_grp").lastResponse;
            if (!this.rList) {
                setTimeout(function () {
                    console.log("waiting R");
                    that.handleRepeatables(response);
                }, 200);
                return;
            } else {
                this.repeatables = response.reduce(function (value, element) {
                    var repeatable = that.rList.filter(function (r) {
                        return r.id === element.repeatableid;
                    });
                    return value + repeatable[0].points;
                }, 0);
            }
        },

        handlePlayerInfo: function () {
            var pid = this.pid;
            var response = document.getElementById("a_player").lastResponse;
            var data = response.filter(function (d) {
                return d.id == pid;
            })[0];
            var index = response.indexOf(data);
            if (index > -1) {
                this.place = index + 1;
                this.player = data.leaguename;
                this.points = data.points;
            } else {
                console.log(response);
            }
        },

        ready: function () {
            if (document.cookie.indexOf("token=") === -1) {
                page.redirect("/login");
            }

            this.pid = this.getCookie("id");
            this.header = {"Authorization": "Bearer " + this.getCookie("token")};
        }
      });
    })();
  </script>
</dom-module>
